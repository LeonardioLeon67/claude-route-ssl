#!/bin/bash

# Claude Route SSL Global Management Tool
# å…¨å±€é¡¹ç›®ç®¡ç†å·¥å…· - directå‘½ä»¤

# é¡¹ç›®é…ç½®
PROJECT_DIR="/home/leon/claude-route-ssl/claude-route-ssl"
SHELL_DIR="$PROJECT_DIR/shell"
PROJECT_NAME="Claude Route SSL"
VERSION="1.0.0"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo -e "${CYAN}Direct - $PROJECT_NAME Management Tool v$VERSION${NC}"
    echo -e "${CYAN}=================================================================${NC}"
    echo ""
    echo -e "${GREEN}Usage:${NC}"
    echo -e "  direct <command> [options]"
    echo ""
    echo -e "${GREEN}Available Commands:${NC}"
    echo -e "  ${YELLOW}run${NC}                    å¯åŠ¨Claude Route SSLé¡¹ç›®"
    echo -e "  ${YELLOW}restart${NC}                é‡å¯Claude Route SSLé¡¹ç›®"
    echo -e "  ${YELLOW}stop${NC}                   åœæ­¢Claude Route SSLé¡¹ç›®"
    echo -e "  ${YELLOW}status${NC}                 æŸ¥çœ‹é¡¹ç›®çŠ¶æ€"
    echo -e "  ${YELLOW}trial${NC}                  ç”ŸæˆTrialçº§åˆ«äº§å“å¯†é’¥ï¼ˆ1å¤©æœ‰æ•ˆæœŸï¼‰"
    echo -e "  ${YELLOW}medium <account>${NC}       ç”ŸæˆMediumçº§åˆ«äº§å“å¯†é’¥"
    echo -e "  ${YELLOW}high <account>${NC}         ç”ŸæˆHighçº§åˆ«äº§å“å¯†é’¥"
    echo -e "  ${YELLOW}supreme <account>${NC}      ç”ŸæˆSupremeçº§åˆ«äº§å“å¯†é’¥"
    echo -e "  ${YELLOW}pool${NC}                   æŸ¥çœ‹è´¦æˆ·æ± çŠ¶æ€å’Œslotåˆ†é…æƒ…å†µ"
    echo -e "  ${YELLOW}recover <account>${NC}      æ¢å¤è¢«é»‘åå•çš„è´¦æˆ·"
    echo -e "  ${YELLOW}logs${NC}                   æŸ¥çœ‹PM2æ—¥å¿—"
    echo -e "  ${YELLOW}monitor${NC}                æ‰“å¼€PM2ç›‘æ§é¢æ¿"
    echo -e "  ${YELLOW}help${NC}                   æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo -e "  ${YELLOW}version${NC}                æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo ""
    echo -e "${GREEN}Examples:${NC}"
    echo -e "  direct run                   # å¯åŠ¨é¡¹ç›®"
    echo -e "  direct status                # æŸ¥çœ‹çŠ¶æ€"
    echo -e "  direct trial                 # ç”ŸæˆTrialå¯†é’¥ï¼ˆ1å¤©æœ‰æ•ˆæœŸï¼‰"
    echo -e "  direct medium testuser       # ç”ŸæˆMediumå¯†é’¥"
    echo -e "  direct high production       # ç”ŸæˆHighå¯†é’¥"
    echo -e "  direct supreme premium       # ç”ŸæˆSupremeå¯†é’¥"
    echo -e "  direct pool                  # æŸ¥çœ‹è´¦æˆ·æ± çŠ¶æ€"
    echo -e "  direct recover jasonlucy002  # æ¢å¤é»‘åå•è´¦æˆ·"
    echo ""
    echo -e "${GREEN}Project Info:${NC}"
    echo -e "  Project Directory: ${BLUE}$PROJECT_DIR${NC}"
    echo -e "  HTTPS Access: ${BLUE}https://api.justprompt.pro${NC}"
    echo -e "  Local Access: ${BLUE}http://127.0.0.1:8080${NC}"
    echo ""
}

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
show_version() {
    echo -e "${CYAN}Direct - $PROJECT_NAME Management Tool${NC}"
    echo -e "Version: ${GREEN}$VERSION${NC}"
    echo -e "Project: ${BLUE}$PROJECT_NAME${NC}"
    echo -e "Location: ${BLUE}$PROJECT_DIR${NC}"
    echo ""
}

# æ£€æŸ¥é¡¹ç›®ç›®å½•
check_project() {
    if [ ! -d "$PROJECT_DIR" ]; then
        echo -e "${RED}âŒ é”™è¯¯: é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR${NC}"
        exit 1
    fi
    
    if [ ! -d "$SHELL_DIR" ]; then
        echo -e "${RED}âŒ é”™è¯¯: è„šæœ¬ç›®å½•ä¸å­˜åœ¨: $SHELL_DIR${NC}"
        exit 1
    fi
}

# æ‰§è¡Œè„šæœ¬
run_script() {
    local script_name="$1"
    local script_path="$SHELL_DIR/$script_name"
    
    if [ ! -f "$script_path" ]; then
        echo -e "${RED}âŒ é”™è¯¯: è„šæœ¬ä¸å­˜åœ¨: $script_path${NC}"
        exit 1
    fi
    
    if [ ! -x "$script_path" ]; then
        echo -e "${RED}âŒ é”™è¯¯: è„šæœ¬æ²¡æœ‰æ‰§è¡Œæƒé™: $script_path${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}ğŸ”„ æ­£åœ¨æ‰§è¡Œ: $script_name${NC}"
    echo -e "${PURPLE}ğŸ“ å·¥ä½œç›®å½•: $SHELL_DIR${NC}"
    echo ""
    
    cd "$SHELL_DIR"
    bash "$script_path"
}

# æ‰§è¡Œå¸¦å‚æ•°çš„è„šæœ¬
run_script_with_args() {
    local script_name="$1"
    shift
    local script_path="$SHELL_DIR/$script_name"
    
    if [ ! -f "$script_path" ]; then
        echo -e "${RED}âŒ é”™è¯¯: è„šæœ¬ä¸å­˜åœ¨: $script_path${NC}"
        exit 1
    fi
    
    if [ ! -x "$script_path" ]; then
        echo -e "${RED}âŒ é”™è¯¯: è„šæœ¬æ²¡æœ‰æ‰§è¡Œæƒé™: $script_path${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}ğŸ”„ æ­£åœ¨æ‰§è¡Œ: $script_name $@${NC}"
    echo -e "${PURPLE}ğŸ“ å·¥ä½œç›®å½•: $SHELL_DIR${NC}"
    echo ""
    
    cd "$SHELL_DIR"
    bash "$script_path" "$@"
}

# ä¸»å‡½æ•°
main() {
    # æ£€æŸ¥é¡¹ç›®ç›®å½•
    check_project
    
    # æ£€æŸ¥å‚æ•°
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    # è§£æå‘½ä»¤
    case "$1" in
        "run")
            echo -e "${GREEN}ğŸš€ å¯åŠ¨ $PROJECT_NAME${NC}"
            run_script "run.sh"
            ;;
        "restart")
            echo -e "${YELLOW}ğŸ”„ é‡å¯ $PROJECT_NAME${NC}"
            run_script "restart.sh"
            ;;
        "stop")
            echo -e "${RED}ğŸ›‘ åœæ­¢ $PROJECT_NAME${NC}"
            run_script "stop.sh"
            ;;
        "status")
            echo -e "${CYAN}ğŸ“Š æŸ¥çœ‹ $PROJECT_NAME çŠ¶æ€${NC}"
            run_script "status.sh"
            ;;
        "trial")
            echo -e "${YELLOW}ğŸ« ç”Ÿæˆ Trial çº§åˆ«äº§å“å¯†é’¥ï¼ˆ1å¤©æœ‰æ•ˆæœŸï¼‰${NC}"
            run_script "trial.sh"
            ;;
        "medium")
            if [ -z "$2" ]; then
                echo -e "${RED}âŒ é”™è¯¯: è¯·æä¾›è´¦æˆ·å${NC}"
                echo -e "${YELLOW}ç”¨æ³•: direct medium <è´¦æˆ·å>${NC}"
                exit 1
            fi
            echo -e "${GREEN}ğŸ’° ç”Ÿæˆ Medium çº§åˆ«äº§å“å¯†é’¥${NC}"
            echo -e "${BLUE}è´¦æˆ·: $2${NC}"
            run_script_with_args "medium.sh" "$2"
            ;;
        "high")
            if [ -z "$2" ]; then
                echo -e "${RED}âŒ é”™è¯¯: è¯·æä¾›è´¦æˆ·å${NC}"
                echo -e "${YELLOW}ç”¨æ³•: direct high <è´¦æˆ·å>${NC}"
                exit 1
            fi
            echo -e "${PURPLE}ğŸ’ ç”Ÿæˆ High çº§åˆ«äº§å“å¯†é’¥${NC}"
            echo -e "${BLUE}è´¦æˆ·: $2${NC}"
            run_script_with_args "high.sh" "$2"
            ;;
        "supreme")
            if [ -z "$2" ]; then
                echo -e "${RED}âŒ é”™è¯¯: è¯·æä¾›è´¦æˆ·å${NC}"
                echo -e "${YELLOW}ç”¨æ³•: direct supreme <è´¦æˆ·å>${NC}"
                exit 1
            fi
            echo -e "${CYAN}ğŸ‘‘ ç”Ÿæˆ Supreme çº§åˆ«äº§å“å¯†é’¥${NC}"
            echo -e "${BLUE}è´¦æˆ·: $2${NC}"
            run_script_with_args "supreme.sh" "$2"
            ;;
        "pool")
            echo -e "${CYAN}ğŸ“Š æŸ¥çœ‹è´¦æˆ·æ± çŠ¶æ€${NC}"
            run_script "pool.sh"
            ;;
        "recover")
            if [ -z "$2" ]; then
                echo -e "${RED}âŒ é”™è¯¯: è¯·æä¾›è´¦æˆ·å${NC}"
                echo -e "${YELLOW}ç”¨æ³•: direct recover <è´¦æˆ·å>${NC}"
                exit 1
            fi
            echo -e "${GREEN}ğŸ”§ æ¢å¤é»‘åå•è´¦æˆ·${NC}"
            echo -e "${BLUE}è´¦æˆ·: $2${NC}"
            run_script_with_args "recover.sh" "$2"
            ;;
        "logs")
            echo -e "${CYAN}ğŸ“ æŸ¥çœ‹ PM2 æ—¥å¿—${NC}"
            if command -v pm2 &> /dev/null; then
                pm2 logs claude-proxy
            else
                echo -e "${RED}âŒ PM2 æœªå®‰è£…${NC}"
                exit 1
            fi
            ;;
        "monitor")
            echo -e "${CYAN}ğŸ“Š æ‰“å¼€ PM2 ç›‘æ§é¢æ¿${NC}"
            if command -v pm2 &> /dev/null; then
                pm2 monit
            else
                echo -e "${RED}âŒ PM2 æœªå®‰è£…${NC}"
                exit 1
            fi
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        "version"|"--version"|"-v")
            show_version
            ;;
        *)
            echo -e "${RED}âŒ é”™è¯¯: æœªçŸ¥å‘½ä»¤ '$1'${NC}"
            echo ""
            echo -e "${YELLOW}ğŸ’¡ ä½¿ç”¨ 'direct help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤${NC}"
            exit 1
            ;;
    esac
}

# é”™è¯¯å¤„ç†
set -e
trap 'echo -e "\n${RED}âŒ å‘½ä»¤æ‰§è¡Œä¸­æ–­${NC}"' INT

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
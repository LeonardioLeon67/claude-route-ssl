# Redisæ•°æ®è¿ç§»å·¥å…·

Claude Route SSLé¡¹ç›®çš„Redisæ•°æ®å¤‡ä»½å’Œæ¢å¤å·¥å…·é›†ï¼Œç”¨äº6380ç«¯å£Rediså®ä¾‹çš„æ•°æ®è¿ç§»ã€‚

## ğŸ“‚ ç›®å½•ç»“æ„

```
redis-migrate/
â”œâ”€â”€ redis-backup.sh          # å¤‡ä»½è„šæœ¬
â”œâ”€â”€ redis-restore.sh         # æ¢å¤è„šæœ¬
â”œâ”€â”€ redis-backup-file/       # å¤‡ä»½æ–‡ä»¶å­˜å‚¨ç›®å½•
â”‚   â”œâ”€â”€ redis_backup_*.rdb  # RDBå¤‡ä»½æ–‡ä»¶
â”‚   â”œâ”€â”€ backup_info_*.json  # å¤‡ä»½ä¿¡æ¯æ–‡ä»¶
â”‚   â””â”€â”€ backup_keys_*.txt   # é”®ååˆ—è¡¨æ–‡ä»¶
â””â”€â”€ README.md               # æœ¬è¯´æ˜æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¤‡ä»½æ•°æ®

```bash
cd /home/leon/claude-route-ssl/claude-route-ssl/redis-migrate
./redis-backup.sh
```

### æ¢å¤æ•°æ®

```bash
cd /home/leon/claude-route-ssl/claude-route-ssl/redis-migrate
./redis-restore.sh
```

## ğŸ“¦ redis-backup.sh å¤‡ä»½è„šæœ¬

### åŠŸèƒ½ç‰¹ç‚¹

- âœ… è‡ªåŠ¨è¿æ¥6380ç«¯å£çš„Rediså®ä¾‹
- âœ… åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„RDBå¿«ç…§å¤‡ä»½
- âœ… å¯¼å‡ºæ‰€æœ‰é”®ååˆ—è¡¨ä¾›å‚è€ƒ
- âœ… ç”Ÿæˆè¯¦ç»†çš„JSONæ ¼å¼å¤‡ä»½ä¿¡æ¯
- âœ… ç»Ÿè®¡å„ç±»ä¸šåŠ¡é”®çš„æ•°é‡åˆ†å¸ƒ
- âœ… è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘10ä¸ªï¼‰
- âœ… ä½¿ç”¨ç›¸å¯¹è·¯å¾„å­˜å‚¨ï¼Œä¾¿äºé¡¹ç›®æ•´ä½“è¿ç§»

### å¤‡ä»½å†…å®¹ç»Ÿè®¡

è„šæœ¬ä¼šç»Ÿè®¡ä»¥ä¸‹ç±»å‹çš„é”®ï¼š
- å®¢æˆ·ç«¯å¯†é’¥ (`client_keys:*`)
- Trialçº§åˆ«äº§å“ (`trial_products:*`)
- Mediumçº§åˆ«äº§å“ (`medium_products:*`)
- Highçº§åˆ«äº§å“ (`high_products:*`)
- Supremeçº§åˆ«äº§å“ (`supreme_products:*`)
- å„çº§åˆ«Slotå ç”¨ (`*_pool:slots:*`)
- é»‘åå•è®°å½• (`account_blacklist:*`)
- Tokenåˆ·æ–°ç›¸å…³ (`refresh_*`)
- æ°¸ä¹…ç»‘å®šå…³ç³» (`permanent_binding:*`)

### ç”Ÿæˆçš„å¤‡ä»½æ–‡ä»¶

æ¯æ¬¡å¤‡ä»½ä¼šç”Ÿæˆ3ä¸ªæ–‡ä»¶ï¼ˆæ—¶é—´æˆ³æ ¼å¼ï¼šYYYYMMDD_HHMMSSï¼‰ï¼š

1. **redis_backup_[æ—¶é—´æˆ³].rdb**
   - Redisæ•°æ®åº“çš„å®Œæ•´RDBå¿«ç…§
   - åŒ…å«æ‰€æœ‰é”®å€¼å¯¹æ•°æ®
   - å¯ç›´æ¥ç”¨äºæ¢å¤

2. **backup_info_[æ—¶é—´æˆ³].json**
   - å¤‡ä»½çš„å…ƒä¿¡æ¯
   - åŒ…å«å¤‡ä»½æ—¶é—´ã€é”®æ•°é‡ã€å†…å­˜ä½¿ç”¨ç­‰
   - å„ç±»é”®çš„è¯¦ç»†ç»Ÿè®¡

3. **backup_keys_[æ—¶é—´æˆ³].txt**
   - æ‰€æœ‰é”®åçš„åˆ—è¡¨
   - ç”¨äºæ•°æ®éªŒè¯å’Œå‚è€ƒ

### ä½¿ç”¨ç¤ºä¾‹

```bash
# æ‰§è¡Œå¤‡ä»½
./redis-backup.sh

# è¾“å‡ºç¤ºä¾‹ï¼š
===========================================
     Redis Backup Script for Claude Route SSL
===========================================

[1/6] æ£€æŸ¥Redisè¿æ¥...
âœ… Redisè¿æ¥æˆåŠŸ (ç«¯å£: 6380)
[2/6] åˆ›å»ºå¤‡ä»½ç›®å½•...
âœ… å¤‡ä»½ç›®å½•å·²å­˜åœ¨
[3/6] æ”¶é›†Redisç»Ÿè®¡ä¿¡æ¯...
  ğŸ“Š é”®æ€»æ•°: 132
  ğŸ’¾ å†…å­˜ä½¿ç”¨: 2.15M
[4/6] å¯¼å‡ºæ‰€æœ‰é”®ååˆ—è¡¨...
âœ… å·²å¯¼å‡º 132 ä¸ªé”®å
[5/6] åˆ†æé”®ç±»å‹ç»Ÿè®¡...
[6/6] åˆ›å»ºRDBå¤‡ä»½å¿«ç…§...
âœ… RDBæ–‡ä»¶å·²å¤‡ä»½åˆ°: redis_backup_20250829_054156.rdb

===========================================
        ğŸ‰ å¤‡ä»½å®Œæˆï¼
===========================================
```

## ğŸ”„ redis-restore.sh æ¢å¤è„šæœ¬

### åŠŸèƒ½ç‰¹ç‚¹

- âœ… äº¤äº’å¼é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½æ–‡ä»¶
- âœ… æ˜¾ç¤ºæ¯ä¸ªå¤‡ä»½çš„è¯¦ç»†ä¿¡æ¯
- âœ… æ¢å¤å‰è‡ªåŠ¨åˆ›å»ºå®‰å…¨å¤‡ä»½
- âœ… å®Œæ•´æ¢å¤æ‰€æœ‰Redisæ•°æ®
- âœ… éªŒè¯æ¢å¤åçš„æ•°æ®å®Œæ•´æ€§
- âœ… å¯é€‰è‡ªåŠ¨é‡å¯Claude Route SSLåº”ç”¨
- âœ… æ™ºèƒ½å¤„ç†RedisæœåŠ¡çŠ¶æ€

### æ¢å¤æµç¨‹

1. **é€‰æ‹©å¤‡ä»½** - åˆ—å‡ºæ‰€æœ‰å¯ç”¨å¤‡ä»½ï¼Œæ˜¾ç¤ºåˆ›å»ºæ—¶é—´ã€é”®æ•°ã€æ–‡ä»¶å¤§å°
2. **ç¡®è®¤æ“ä½œ** - æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼Œéœ€è¦è¾“å…¥yesç¡®è®¤
3. **å®‰å…¨å¤‡ä»½** - è‡ªåŠ¨å¤‡ä»½å½“å‰æ•°æ®ï¼ˆå¦‚æœ‰ï¼‰
4. **æ¸…ç©ºæ•°æ®** - ä½¿ç”¨FLUSHALLæ¸…ç©ºå½“å‰æ•°æ®åº“
5. **æ¢å¤æ•°æ®** - å¤åˆ¶å¤‡ä»½RDBæ–‡ä»¶å¹¶é‡å¯RedisåŠ è½½
6. **éªŒè¯ç»“æœ** - æ˜¾ç¤ºæ¢å¤åçš„é”®æ•°é‡å’Œç±»å‹ç»Ÿè®¡
7. **é‡å¯åº”ç”¨** - å¯é€‰é‡å¯Claude Route SSLåº”ç”¨

### ä½¿ç”¨ç¤ºä¾‹

```bash
# æ‰§è¡Œæ¢å¤
./redis-restore.sh

# äº¤äº’ç¤ºä¾‹ï¼š
===========================================
     Redis Restore Script for Claude Route SSL
===========================================

å¯ç”¨çš„å¤‡ä»½æ–‡ä»¶:

  [ 1] redis_backup_20250829_054156.rdb
       æ—¶é—´: 2025-08-29 05:41:56 | é”®æ•°: 132 | å¤§å°: 40K

  [ 2] redis_backup_20250829_050000.rdb
       æ—¶é—´: 2025-08-29 05:00:00 | é”®æ•°: 128 | å¤§å°: 38K

è¯·é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½æ–‡ä»¶ç¼–å· (1-2):
> 1

âš ï¸  è­¦å‘Š: æ¢å¤æ“ä½œå°†ä¼šæ¸…ç©ºå½“å‰Redisçš„æ‰€æœ‰æ•°æ®ï¼
æ˜¯å¦ç»§ç»­? (yes/no):
> yes

[æ¢å¤è¿‡ç¨‹...]

===========================================
        ğŸ‰ æ•°æ®æ¢å¤å®Œæˆï¼
===========================================
  ğŸ“¦ æ¢å¤çš„å¤‡ä»½: redis_backup_20250829_054156.rdb
  ğŸ“Š æ¢å¤çš„é”®æ•°: 132
  ğŸ’¾ å†…å­˜ä½¿ç”¨: 2.15M

æ˜¯å¦ç°åœ¨é‡å¯Claude Route SSLåº”ç”¨? (yes/no):
> yes
```

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¦†ç›–è­¦å‘Š**
   - æ¢å¤æ“ä½œä¼šæ¸…ç©ºç›®æ ‡Redisçš„æ‰€æœ‰æ•°æ®
   - æ¢å¤å‰ä¼šè‡ªåŠ¨åˆ›å»ºå®‰å…¨å¤‡ä»½
   - éœ€è¦æ˜ç¡®è¾“å…¥yesç¡®è®¤æ“ä½œ

2. **æƒé™è¦æ±‚**
   - éœ€è¦Redisè®¿é—®æƒé™
   - éœ€è¦æ–‡ä»¶ç³»ç»Ÿè¯»å†™æƒé™
   - é‡å¯åº”ç”¨éœ€è¦ç›¸åº”çš„è¿›ç¨‹ç®¡ç†æƒé™

3. **ç«¯å£é…ç½®**
   - è„šæœ¬å›ºå®šä½¿ç”¨6380ç«¯å£
   - å¦‚éœ€ä¿®æ”¹ç«¯å£ï¼Œç¼–è¾‘è„šæœ¬ä¸­çš„`REDIS_PORT`å˜é‡

## ğŸ“ è¿ç§»åˆ°å…¶ä»–æœåŠ¡å™¨

### æ­¥éª¤1ï¼šæ‰“åŒ…å¤‡ä»½æ–‡ä»¶

åœ¨æºæœåŠ¡å™¨ä¸Šï¼š
```bash
cd /home/leon/claude-route-ssl/claude-route-ssl
tar -czf redis-migrate-backup.tar.gz redis-migrate/
```

### æ­¥éª¤2ï¼šä¼ è¾“åˆ°ç›®æ ‡æœåŠ¡å™¨

ä½¿ç”¨scpæˆ–å…¶ä»–æ–¹å¼ä¼ è¾“ï¼š
```bash
scp redis-migrate-backup.tar.gz user@target-server:/path/to/claude-route-ssl/
```

### æ­¥éª¤3ï¼šåœ¨ç›®æ ‡æœåŠ¡å™¨æ¢å¤

åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šï¼š
```bash
cd /path/to/claude-route-ssl
tar -xzf redis-migrate-backup.tar.gz
cd redis-migrate
./redis-restore.sh
```

## ğŸ›  æ•…éšœæ’é™¤

### Redisè¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œåœ¨6380ç«¯å£
redis-cli -p 6380 ping

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨Redis
redis-server --port 6380 --daemonize yes
```

### å¤‡ä»½ç›®å½•ä¸å­˜åœ¨

è„šæœ¬ä¼šè‡ªåŠ¨åˆ›å»ºå¤‡ä»½ç›®å½•ï¼Œå¦‚æœå¤±è´¥è¯·æ£€æŸ¥ï¼š
- å½“å‰ç”¨æˆ·çš„å†™å…¥æƒé™
- ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³

### æ¢å¤åæ•°æ®ä¸å®Œæ•´

1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
2. æŸ¥çœ‹backup_info_*.jsonç¡®è®¤å¤‡ä»½æ—¶çš„é”®æ•°é‡
3. ç¡®ä¿Redisæœ‰è¶³å¤Ÿçš„å†…å­˜åŠ è½½æ‰€æœ‰æ•°æ®

## ğŸ“Š å¤‡ä»½ç­–ç•¥å»ºè®®

### å®šæœŸå¤‡ä»½

å»ºè®®ä½¿ç”¨cronå®šæ—¶ä»»åŠ¡ï¼š
```bash
# æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨å¤‡ä»½
0 3 * * * cd /home/leon/claude-route-ssl/claude-route-ssl/redis-migrate && ./redis-backup.sh
```

### å¤‡ä»½ä¿ç•™ç­–ç•¥

- è„šæœ¬è‡ªåŠ¨ä¿ç•™æœ€è¿‘10ä¸ªå¤‡ä»½
- é‡è¦ç‰ˆæœ¬å‘å¸ƒå‰å»ºè®®æ‰‹åŠ¨å¤‡ä»½
- å®šæœŸå°†å¤‡ä»½æ–‡ä»¶å½’æ¡£åˆ°å…¶ä»–å­˜å‚¨

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

å¦‚éœ€ä¿®æ”¹é»˜è®¤é…ç½®ï¼Œç¼–è¾‘è„šæœ¬ä¸­çš„ä»¥ä¸‹å˜é‡ï¼š

```bash
# Redisç«¯å£
REDIS_PORT=6380

# Redisä¸»æœº
REDIS_HOST="localhost"

# ä¿ç•™çš„å¤‡ä»½æ•°é‡ï¼ˆé»˜è®¤10ä¸ªï¼‰
# åœ¨redis-backup.shä¸­ä¿®æ”¹ç¬¬236è¡Œçš„æ•°å­—
if [ $BACKUP_COUNT -gt 10 ]; then
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. RedisæœåŠ¡çŠ¶æ€ï¼š`redis-cli -p 6380 ping`
2. é¡¹ç›®è¿è¡ŒçŠ¶æ€ï¼š`direct status`
3. æŸ¥çœ‹PM2æ—¥å¿—ï¼š`pm2 logs`

---

*æœ¬å·¥å…·æ˜¯Claude Route SSLé¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºç®€åŒ–Redisæ•°æ®çš„å¤‡ä»½å’Œè¿ç§»æ“ä½œã€‚*